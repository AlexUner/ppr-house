<!--
  Конструктор навеса из PPR‑труб v2
  Обновлено: интерактивные узлы, динамические размеры, улучшенный UX/UI
-->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Конструктор навеса из PPR‑труб</title>
<!-- Konva.js для интерактивной графики -->
<script src="https://unpkg.com/konva@8.4.3/konva.min.js"></script>
<style>
  :root{
    --bg:#f7f9fa; --green:#2e8555; --border:#d0d7de; --text:#222;
    --node:#2e8555; --line:#333; --dim:#445; --dim-bg:#fff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:"Inter",Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  h1{margin:0;padding:0.8rem;background:var(--green);color:#fff;font-size:1.2rem;text-align:center}
  #app{display:flex;height:calc(100% - 52px)}
  /* ======== Панель управления ========= */
  #sidebar{width:320px;max-width:40%;background:#fff;border-right:1px solid var(--border);padding:1rem;overflow:auto}
  #sidebar h2{font-size:1rem;margin:0.8rem 0 0.4rem}
  label{font-size:0.8rem;display:block;margin:0.4rem 0 0.2rem}
  input[type="number"],select{width:100%;padding:0.35rem;border:1px solid var(--border);border-radius:4px}
  #pipeList{margin-top:0.6rem;font-size:0.85rem}
  .pipe{border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.6rem;margin-bottom:0.4rem;background:#fafafa;display:flex;justify-content:space-between}
  /* ======== Область холстов ========= */
  #stageWrap{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1rem;padding:1rem;overflow:auto}
  .view{background:#fff;border:1px solid var(--border);border-radius:8px;position:relative}
  .konvajs-content{outline:none}
  .caption{position:absolute;bottom:6px;left:6px;font-size:0.8rem;background:rgba(255,255,255,0.8);padding:2px 6px;border-radius:4px}
  /* Всплывающая подсказка длины */
  .tooltip{position:absolute;padding:2px 6px;background:var(--dim-bg);border:1px solid var(--border);border-radius:4px;font-size:0.74rem;pointer-events:none;white-space:nowrap;color:var(--dim);}
</style>
</head>
<body>
<h1>Конструктор навеса из PPR‑труб</h1>
<div id="app">
  <!-- ======= ПАНЕЛЬ =========== -->
  <aside id="sidebar">
    <h2>Параметры основания</h2>
    <label>Ширина (м)</label>
    <input type="number" id="inpWidth" min="1" max="10" step="0.1" value="2">
    <label>Глубина (м)</label>
    <input type="number" id="inpDepth" min="1" max="10" step="0.1" value="3">

    <h2>Параметры крыши</h2>
    <label>Фиксация скатов</label>
    <select id="roofMode">
      <option value="fixed">По длине стороны</option>
      <option value="angle">По углу</option>
    </select>
    <div id="fixedBox">
      <label>Длина ската (м)</label>
      <input type="number" id="inpSide" min="1" max="10" step="0.1" value="2">
    </div>
    <div id="angleBox" style="display:none">
      <label>Угол ската (°)</label>
      <input type="number" id="inpAngle" min="5" max="60" step="1" value="15">
    </div>

    <h2>Секция узлов</h2>
    <button id="btnAddSupport" style="width:100%;padding:0.5rem;margin:0.2rem 0;background:var(--green);color:#fff;border:none;border-radius:4px;cursor:pointer">Добавить промежуточную стойку</button>

    <h2>Список труб</h2>
    <div id="pipeList"></div>
  </aside>

  <!-- ======= ХОЛСТЫ ========= -->
  <section id="stageWrap">
    <div class="view"><div id="frontView"></div><span class="caption">Вид спереди</span></div>
    <div class="view"><div id="sideView"></div><span class="caption">Вид сбоку</span></div>
    <div class="view"><div id="topView"></div><span class="caption">Вид сверху</span></div>
  </section>
</div>

<!-- ======= Шаблон всплывающей подсказки (будет клонироваться) -->
<div id="tooltip" class="tooltip" style="display:none"></div>

<script>
/* =========================================================
   МОДЕЛЬ ДАННЫХ
   ========================================================= */
const model={
  W:2,       // ширина
  D:3,       // глубина
  side:2,    // длина ската
  angle:15,  // угол ската (если режим angle)
  roofMode:'fixed',
  supports:[] // промежуточные стойки (x-координаты 0..W)
};

/* =========================================================
   КОНСТАНТЫ
   ========================================================= */
const M=50; // Маштаб: 1 м = 50 px, для топ/сайд; фронт подбираем отдельно
const PIPE_MAX=3; // макс. длина трубы без муфты (м)

/* =========================================================
   ПОЛЕЗНЫЕ ФУНКЦИИ
   ========================================================= */
const rad=d=>d*Math.PI/180;
const dist=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1);

/* =========================================================
   ОБНОВЛЕНИЕ ПАРАМЕТРОВ UI → модель
   ========================================================= */
const $=id=>document.getElementById(id);
$('inpWidth').oninput=e=>{model.W=parseFloat(e.target.value);updateAll();};
$('inpDepth').oninput=e=>{model.D=parseFloat(e.target.value);updateAll();};
$('inpSide').oninput=e=>{model.side=parseFloat(e.target.value);updateAll();};
$('inpAngle').oninput=e=>{model.angle=parseFloat(e.target.value);updateAll();};
$('roofMode').onchange=e=>{
  model.roofMode=e.target.value;
  $('fixedBox').style.display=model.roofMode==='fixed'?'block':'none';
  $('angleBox').style.display=model.roofMode==='angle'?'block':'none';
  updateAll();
};
$('btnAddSupport').onclick=()=>{
  // Добавляем стойку посередине проекции спереди
  const x=model.W/2;
  if(!model.supports.includes(x)) model.supports.push(x);
  updateAll();
};

/* =========================================================
   ПОДГОТОВКА ХОЛСТОВ KONVA
   ========================================================= */
const stages={};
['front','side','top'].forEach(id=>{
  const container=id+'View';
  const stage=new Konva.Stage({container:container,width:340,height:260});
  const layer=new Konva.Layer();
  stage.add(layer);
  stages[id]={stage,layer};
});

// Вспомогательный тултип
const tooltipEl=$('tooltip');
function showTooltip(text,x,y){tooltipEl.textContent=text;tooltipEl.style.left=x+'px';tooltipEl.style.top=y+'px';tooltipEl.style.display='block';}
function hideTooltip(){tooltipEl.style.display='none';}

/* =========================================================
   СОЗДАНИЕ/ОБНОВЛЕНИЕ ПРОЕКЦИЙ
   ========================================================= */
function updateFront(){
  const {stage,layer}=stages.front;
  layer.destroyChildren();
  const pad=20; // отступ
  // Координаты оснований и вершины в метрах
  const half=model.W/2;
  let h; // высота крыши (м)
  if(model.roofMode==='fixed') h=Math.sqrt(Math.max(model.side**2-half**2,0));
  else h=Math.tan(rad(model.angle))*half;
  // Холст‑scale: помещаем по ширине с паддингом
  const scale=(stage.width()-2*pad)/model.W;
  const baseY=stage.height()-pad;
  // базовые узлы
  const leftX=pad;
  const rightX=pad+model.W*scale;
  const apexX=pad+half*scale;
  const apexY=baseY-h*scale;

  // функция узла
  const makeNode=(x,y,draggable,name)=>{
    const c=new Konva.Circle({x,y,r:5,fill:'var(--node)',draggable});
    layer.add(c);
    if(draggable){
      c.on('dragmove',()=>{
        if(name==='apex'){
          // apex只能 вверх/вниз по Y (сохраняем симметрию)
          c.x(apexX);
          // ограничение высоты >=0
          c.y(Math.min(baseY-20,c.y()));
        }
        updateModelFromFront();
      });
      c.on('mouseenter',()=>stage.container().style.cursor='grab');
      c.on('mouseleave',()=>stage.container().style.cursor='default');
    }
    return c;
  };
  // Создаём объекты
  const leftNode = makeNode(leftX,baseY,false,'left');
  const rightNode= makeNode(rightX,baseY,false,'right');
  const apexNode = makeNode(apexX,apexY,true,'apex');
  // Линии скатов
  const slopeL=new Konva.Line({points:[leftX,baseY,apexX,apexY],stroke:'var(--line)',strokeWidth:2});
  const slopeR=new Konva.Line({points:[rightX,baseY,apexX,apexY],stroke:'var(--line)',strokeWidth:2});
  layer.add(slopeL,slopeR);
  // Вертикальные стойки основания + промежуточные
  const supports=[0,...model.supports.sort((a,b)=>a-b),model.W];
  supports.forEach(xm=>{
    const x=pad+xm*scale;
    const post=new Konva.Line({points:[x,baseY,x,baseY],stroke:'var(--line)',strokeWidth:2});
    layer.add(post);
  });
  // Длина ската label
  const len=model.roofMode==='fixed'?model.side:Math.hypot(model.W/2,h);
  const midX=(leftX+apexX)/2;
  const midY=(baseY+apexY)/2;
  const lbl=new Konva.Text({x:midX,y:midY-18,text:len.toFixed(2)+' м',fontSize:12,fill:'var(--dim)',padding:4});
  layer.add(lbl);
  layer.draw();
}

function updateSide(){
  const {stage,layer}=stages.side;
  layer.destroyChildren();
  const pad=20;
  const scale=(stage.width()-2*pad)/model.D;
  const baseY=stage.height()-pad;
  let h;const half=model.W/2;
  if(model.roofMode==='fixed') h=Math.sqrt(Math.max(model.side**2-half**2,0));
  else h=Math.tan(rad(model.angle))*half;

  const leftX=pad;
  const rightX=pad+model.D*scale;
  const apexY=baseY-h*scale;

  // контур
  const rect=new Konva.Rect({x:leftX,y:apexY,width:model.D*scale,height:h*scale,stroke:'var(--line)',strokeWidth:2});
  layer.add(rect);
  // длина глубины label
  const lbl=new Konva.Text({x:(leftX+rightX)/2-20,y:baseY+4,text:model.D.toFixed(2)+' м',fontSize:12,fill:'var(--dim)'});
  layer.add(lbl);
  layer.draw();
}

function updateTop(){
  const {stage,layer}=stages.top;
  layer.destroyChildren();
  const pad=20;
  const scale=(stage.width()-2*pad)/model.W;
  const scaleY=(stage.height()-2*pad)/model.D;
  const baseX=pad;
  const baseY=pad;

  const rect=new Konva.Rect({x:baseX,y:baseY,width:model.W*scale,height:model.D*scaleY,stroke:'var(--line)',strokeWidth:2});
  layer.add(rect);
  // Размеры
  const lblW=new Konva.Text({x:baseX+model.W*scale/2-20,y:baseY-18,text:model.W.toFixed(2)+' м',fontSize:12,fill:'var(--dim)'});
  const lblD=new Konva.Text({x:baseX+model.W*scale+4,y:baseY+model.D*scaleY/2-6,text:model.D.toFixed(2)+' м',fontSize:12,fill:'var(--dim)'});
  layer.add(lblW,lblD);
  layer.draw();
}

/* =========================================================
   ПЕРЕСЧЁТ СПИСКА ТРУБ И МУФТ
   ========================================================= */
function calcPipes(){
  const list=[];
  const half=model.W/2;
  let h;
  if(model.roofMode==='fixed') h=Math.sqrt(Math.max(model.side**2-half**2,0));
  else h=Math.tan(rad(model.angle))*half;
  const slope=Math.hypot(half,h);
  // основание (периметр)
  list.push({id:'baseW1',len:model.W});
  list.push({id:'baseW2',len:model.W});
  list.push({id:'baseD1',len:model.D});
  list.push({id:'baseD2',len:model.D});
  // стойки
  list.push({id:'postL',len:h});
  list.push({id:'postR',len:h});
  model.supports.forEach((x,i)=>list.push({id:'postS'+(i+1),len:h}));
  // конёк
  list.push({id:'ridge',len:model.D});
  // скаты
  list.push({id:'slopeL',len:slope});
  list.push({id:'slopeR',len:slope});
  return list;
}

function buildPipeUI(){
  const list=calcPipes();
  const cont=$('pipeList');
  cont.innerHTML='';
  list.forEach(p=>{
    const el=document.createElement('div');el.className='pipe';
    // mufts
    const seg=Math.ceil(p.len/PIPE_MAX);
    el.innerHTML=`<span>${p.id}</span><span>${p.len.toFixed(2)} м ${seg>1?`(${seg}×≤${PIPE_MAX})`:''}</span>`;
    cont.appendChild(el);
  });
}

/* =========================================================
   ОТНОШЕНИЕ ПЕРЕМЕЩЕНИЯ APEX → модель
   ========================================================= */
function updateModelFromFront(){
  const {stage,layer}=stages.front;
  const apex=layer.findOne('Circle'); // первый draggable — apex
  if(!apex) return;
  const pad=20;
  const scale=(stage.width()-2*pad)/model.W;
  const apexY=(apex.y());
  const baseY=stage.height()-pad;
  const h=(baseY-apexY)/scale; // м
  const half=model.W/2;
  if(model.roofMode==='fixed'){
    const newSide=Math.hypot(half,h);
    model.side=newSide;
    $('inpSide').value=newSide.toFixed(2);
  }else{
    const newAngle=rad2deg(Math.atan(h/half));
    model.angle=newAngle;
    $('inpAngle').value=newAngle.toFixed(1);
  }
  updateAll();
}
function rad2deg(r){return r*180/Math.PI;}

/* =========================================================
   ГЛАВНЫЙ ВХОД
   ========================================================= */
function updateAll(){
  updateFront();
  updateSide();
  updateTop();
  buildPipeUI();
}
updateAll();

</script>
</body>
</html>
